steps:
- script: |
    echo ##vso[task.prependpath]$(ANDROID_HOME)\tools\bin
 #   echo ##vso[task.setvariable variable=ANDROID_NDK]$(ANDROID_HOME)\android-ndk-r17c
  displayName: 'Add Android to PATH'

- bash: |
    echo ${ANDROID_NDK}
    echo ${ANDROID_HOME}
    ls -la ${ANDROID_HOME}
    printenv

- powershell: |
    Get-ChildItem -path 'C:\Program Files (x86)\Android\android-sdk\licenses' | Remove-Item -Recurse -Confirm:$false -Force
    dir 'C:\Program Files (x86)\Android\android-sdk\licenses'
    $base64Content = "UEsDBBQAAAAAAKJeN06amkPzKgAAACoAAAAhAAAAbGljZW5zZXMvYW5kcm9pZC1nb29nbGV0di1saWNlbnNlDQpmYzk0NmU4ZjIzMWYzZTMxNTliZjBiN2M2NTVjOTI0Y2IyZTM4MzMwUEsDBBQAAAAIAKBrN05E+YSqQwAAAFQAAAAcAAAAbGljZW5zZXMvYW5kcm9pZC1zZGstbGljZW5zZQXByREAIQgEwP9WmYsjhxgOKJN/CNs9vmdOQ2zdRw2dxQnWjqQ/3oIgXQM9vqUiwkiX8ljWea4ZlCF3xTo1pz6w+wdQSwMEFAAAAAAAxV43TpECY7AqAAAAKgAAACQAAABsaWNlbnNlcy9hbmRyb2lkLXNkay1wcmV2aWV3LWxpY2Vuc2UNCjUwNDY2N2Y0YzBkZTdhZjFhMDZkZTlmNGIxNzI3Yjg0MzUxZjI5MTBQSwMEFAAAAAAAzF43TpOr0CgqAAAAKgAAABsAAABsaWNlbnNlcy9nb29nbGUtZ2RrLWxpY2Vuc2UNCjMzYjZhMmI2NDYwN2YxMWI3NTlmMzIwZWY5ZGZmNGFlNWM0N2Q5N2FQSwMEFAAAAAAAz143TqxN4xEqAAAAKgAAACQAAABsaWNlbnNlcy9pbnRlbC1hbmRyb2lkLWV4dHJhLWxpY2Vuc2UNCmQ5NzVmNzUxNjk4YTc3YjY2MmYxMjU0ZGRiZWVkMzkwMWU5NzZmNWFQSwMEFAAAAAAA0l43Tu2ee/8qAAAAKgAAACYAAABsaWNlbnNlcy9taXBzLWFuZHJvaWQtc3lzaW1hZ2UtbGljZW5zZQ0KNjNkNzAzZjU2OTJmZDg5MWQ1YWNhY2ZiZDhlMDlmNDBmYzk3NjEwNVBLAQIUABQAAAAAAKJeN06amkPzKgAAACoAAAAhAAAAAAAAAAEAIAAAAAAAAABsaWNlbnNlcy9hbmRyb2lkLWdvb2dsZXR2LWxpY2Vuc2VQSwECFAAUAAAACACgazdORPmEqkMAAABUAAAAHAAAAAAAAAABACAAAABpAAAAbGljZW5zZXMvYW5kcm9pZC1zZGstbGljZW5zZVBLAQIUABQAAAAAAMVeN06RAmOwKgAAACoAAAAkAAAAAAAAAAEAIAAAAOYAAABsaWNlbnNlcy9hbmRyb2lkLXNkay1wcmV2aWV3LWxpY2Vuc2VQSwECFAAUAAAAAADMXjdOk6vQKCoAAAAqAAAAGwAAAAAAAAABACAAAABSAQAAbGljZW5zZXMvZ29vZ2xlLWdkay1saWNlbnNlUEsBAhQAFAAAAAAAz143TqxN4xEqAAAAKgAAACQAAAAAAAAAAQAgAAAAtQEAAGxpY2Vuc2VzL2ludGVsLWFuZHJvaWQtZXh0cmEtbGljZW5zZVBLAQIUABQAAAAAANJeN07tnnv/KgAAACoAAAAmAAAAAAAAAAEAIAAAACECAABsaWNlbnNlcy9taXBzLWFuZHJvaWQtc3lzaW1hZ2UtbGljZW5zZVBLBQYAAAAABgAGANoBAACPAgAAAAA="
    $content = [System.Convert]::FromBase64String($base64Content)
    Set-Content -Path .\android-sdk-licenses.zip -Value $content -Encoding Byte
    Expand-Archive -Path .\android-sdk-licenses.zip -DestinationPath 'C:\Program Files (x86)\Android\android-sdk' -Force
    dir 'C:\Program Files (x86)\Android\android-sdk\licenses'
  displayName: 'Android SDK workaround'

- script: |
    sdkmanager "system-images;android-19;google_apis;armeabi-v7a"
    sdkmanager "platforms;android-$(ANDROID_BUILD_VERSION)"
    sdkmanager "build-tools;$(ANDROID_TOOLS_VERSION)"
    sdkmanager "add-ons;addon-google_apis-google-23"
    sdkmanager "extras;android;m2repository"    
  displayName: 'Setup Android SDK'

- task: NodeTool@0
  inputs:
    versionSpec: '8.x'
  displayName: 'Install Node.js'

- script: yarn install
  displayName: 'Install depdendencies'

- script: gradlew.bat RNTester:android:app:assembleRelease
  displayName: 'Build'
  
- script: npm test
  displayName: 'Test'

#- task: PublishTestResults@2
#  inputs:
#    testResultsFiles: '$(JEST_JUNIT_OUTPUT)'
#  condition: always()
#  displayName: 'Publish test results'
